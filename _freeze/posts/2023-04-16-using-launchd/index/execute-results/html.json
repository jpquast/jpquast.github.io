{
  "hash": "3b8680772ed6130c6e83576fdefd312f",
  "result": {
    "markdown": "---\ntitle: Setting up Launchd\nsubtitle: Schedule a script on MacOS\ndate: \"2023-04-16\"\nauthor: \"Jan-Philipp Quast\"\ncategories: [coding, Launchd]\nfig-align: center\ncode-link: true\n---\n\n\n`launchd` is a process on macOS that manages the execution and scheduling of background processes (daemons). It replaces older time-based job schedulers for Unix based systems such as `cron`. It is particularly useful if you want to schedule the execution of some of your scripts at specific times or intervals.\n\nI wanted to use `launchd` to automatically download and delete data from a Google Sheets file in which I automatically save temperature and humidity data from a microcontroller. Over time the document would fill up and I would manually need to download and delete the data to make space for more. Therefore, I wrote an R script that takes care of this for me. In order to automate the execution of this script I used `launchd`.\n\n## Getting started\n\nTo set up `launchd`, you'll need to create a LaunchAgent property list file in XML format (`.plist`). This file describes the process or program you want to launch, its arguments, and when and how often to execute it.\n\nIn this short tutorial we will create a simple `.plist` file that simply executes a script at a certain time during the day. There are a lot more customisation options and things you can do with `launchd` that I won't go into here but that you can read up on with the following command.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nman launchd.plist\n```\n:::\n\n\n## Creating a .plist file\n\nThe overall structure of `.plist` file is always identical. Bellow you can find the file that I have created for my specific task that I called `com.jpq.download_and_upload_data.plist`.\n\n\n::: {.cell}\n\n```{.xml .cell-code}\n    <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n    <!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\"\n      \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n    <plist version=\"1.0\">\n    <dict>\n        <key>Label</key>\n        <string>com.jpq.download_and_upload_data</string>\n        <key>ProgramArguments</key>\n        <array>\n            <string>/usr/local/bin/Rscript</string>\n            <string>/Users/user/Documents/sensor_data/download_and_upload_data.R</string>\n        </array>\n        <key>StartCalendarInterval</key>\n        <dict>\n            <key>Hour</key>\n            <integer>13</integer>\n            <key>Minute</key>\n            <integer>0</integer>\n        </dict>\n    </dict>\n    </plist>\n```\n:::\n\n\nYou can see that there are three main `<key>` fields in the file that specify `Label`, `ProgramArguments` and `StartCalendarInterval`.\n\n| `<key>`                 | Description                                                                                      |\n|-----------------|-------------------------------------------------------|\n| `Label`                 | Uniquely identifies the job. Usually the file name. It has the structure `com.creator.FileName`. |\n| `ProgramArguments`      | An array of strings which contain the tokenised arguments and the program to run.                |\n| `StartCalendarInterval` | Contains `<key>`/`integer` fields that specify the time that the script should be executed at.   |\n\n### ProgramArguments\n\n`ProgramArguments` specify the *what* should be executed *how*. You would specify the execution of the script in the same way how you would also execute it in the terminal with the exception that you would tokenise (split up) the prompt.\n\nIn our `.plist` file above I use the `Rscript` interpreter that is usually located at `/usr/local/bin/Rscript` to execute my R script located at `/Users/user/Documents/sensor_data/download_and_upload_data.R`\n\nIf you have a shell script `.sh` file that you want to execute directly you can use `Program` instead of `ProgramArguments` and provide the path to the script directly.\n\n\n::: {.cell}\n\n```{.xml .cell-code}\n<key>Program</key>\n  <string>/Users/user/Scripts/script.sh</string>\n```\n:::\n\n\nIf you want to run the shell script for the first time make sure that you have permission by using `chmod` in the terminal.\n\n::: {.cell}\n\n```{.xml .cell-code}\nchmod u+x script.sh\n```\n:::\n\n\n### StartCalendarInterval\n\nThe `StartCalendarInterval` can specify a specific time point at which the script should be executed. The below example executes the script on the 15th of July at 13:30 if this day is a Sunday.\n\n\n::: {.cell}\n\n```{.xml .cell-code}\n<key>StartCalendarInterval</key>\n    <dict>\n        <key>Day</key>\n        <integer>15</integer>\n        <key>Hour</key>\n        <integer>13</integer>\n        <key>Minute</key>\n        <integer>30</integer>\n        <key>Month</key>\n        <integer>7</integer>\n        <key>Weekday</key>\n        <integer>0</integer>\n    </dict>\n```\n:::\n\n\nIf you simply leave out some of these keys from the dictionary they are treated as a wildcard meaning they are not considered for the execution of the job.\n\n::: callout-note\nOne important advantage of using `launchd` over e.g. `cron` is that if a job could not be executed at its designated time, it will instead be executed at the next possible time. In addition, if a job could not be run on multiple scheduled times it will be executed only once at the next possible time.\n:::\n\nIf you want to execute a script e.g. every 10 minutes you can use `StartInterval` instead:\n\n\n::: {.cell}\n\n```{.xml .cell-code}\n<key>StartInterval</key>\n    <integer>600</integer>\n```\n:::\n\n\n## File location\n\nOnce you have written your `.plist` file you will have to save it in the appropriate directory. There are multiple different [options](https://support.apple.com/en-gb/guide/terminal/apdc6c1077b-5d5d-4d35-9c19-60f2397b2369/mac):\n\n| **Folder**                    | **Usage**                                                         |\n|:------------------------------|:------------------------------------------------------------------|\n| /System/Library/LaunchDaemons | Apple-supplied system daemons                                     |\n| /System/Library/LaunchAgents  | Apple-supplied agents that apply to all users on a per-user basis |\n| /Library/LaunchDaemons        | Third-party system daemons                                        |\n| /Library/LaunchAgents         | Third-party agents that apply to all users on a per-user basis    |\n| \\~/Library/LaunchAgents       | Third-party agents that apply only to the logged-in user          |\n\nAgents are always associated with the logged on user, meaning the scripts are restricted to only a specific user while Deamons are run under the root user and thus run for everyone.\n\nSince my script specifically saves data in a folder associated with my user it is better to use an Agent and not a Daemon. Therefore, I chose the lowest option as my location for the `.plist` file: `/Users/user/Library/LaunchAgents/com.jpq.download_data_from_sheets.plist`\n\n## Loading an Agent\n\nAfter you have saved your `.plist` file in one of the appropriate locations you have to load it using the `launchctl` command in the terminal.\n\n\n::: {.cell}\n\n```{.xml .cell-code}\nlaunchctl load /Users/user/Library/LaunchAgents/com.jpq.download_data_from_sheets.plist\n```\n:::\n\n\n::: callout-note\nIf you want to see all loaded jobs you can use `launchctl list` in the terminal. In order to stop a job use `launchctl unload` instead of `launchctl load` with the path of your file. Using `launchctl start JobLabel` will run the job immediately and not only when scheduled.\n:::\n\nThis is it! Now our script will be executed automatically at the specified time points.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}